<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Rafael Belokurows">
<meta name="dcterms.date" content="2024-05-24">
<meta name="description" content="Can a major layoff be good for business? As far as stock prices are concerned, Causal Inference says it can">
<title>Rafael Belokurows - Using Causal Inference to quantify layoff impact on stock price</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Rafael Belokurows</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> <i class="bi bi-house-door-fill" role="img">
</i> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> <i class="bi bi-card-checklist" role="img">
</i> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume.html"> <i class="bi bi-file-earmark-person" role="img">
</i> 
<span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> <i class="bi bi-pen-fill" role="img">
</i> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../data-viz.html"> <i class="bi bi-graph-up-arrow" role="img">
</i> 
<span class="menu-text">Data Viz</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rafabelokurows"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/rafabelo"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Using Causal Inference to quantify layoff impact on stock price</h1>
                  <div>
        <div class="description">
          Can a major layoff be good for business? As far as stock prices are concerned, Causal Inference says it can
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">finance</div>
                <div class="quarto-category">causal inference</div>
                <div class="quarto-category">stocks</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Rafael Belokurows </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 24, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#obtaining-the-data-and-first-causal-estimation" id="toc-obtaining-the-data-and-first-causal-estimation" class="nav-link active" data-scroll-target="#obtaining-the-data-and-first-causal-estimation">Obtaining the data and first Causal estimation</a></li>
  <li><a href="#improving-the-estimation" id="toc-improving-the-estimation" class="nav-link" data-scroll-target="#improving-the-estimation">Improving the estimation</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><p>Hello, there.</p>
<p>This week I’m sharing a few new methods I’ve tried recently to connect two fields I’m very interested in: <strong>Finance</strong> and <strong>Causal Inference</strong>.</p>
<p><a href="https://www.sap.com/about.html">SAP</a> is a huge world-class all-powerful software company, and even world-class all-powerful companies go through rough patches and reestructuring, as it has happened with SAP over the past few years. Part of this process included a major <a href="https://www.cnbc.com/2024/01/23/sap-plans-job-changes-or-buyouts-for-8000-employees-in-restructuring-plan.html">layoff of 6.000 people in January 2024</a>.</p>
<p>The market responded quite positively, with their stock price on the NY Stock Exchange going up a few percent over the following weeks (and it hasn’t gone down since). Was the layoff causally related with the uptick in stock price? Or was it just a coincidence?</p>
<p>In this post I’m gonna show how I used Causal Inference estimation methods to identify and measure the impact of this particular layoff on their stock price.</p>
<p>If you are somewhat surprised that a big event of layoff would have such a <strong>positive</strong> impact on a company’s value, there are some good resources online on why this happens, and fundamentally, it boils down to the <strong>optics</strong>, i.e.&nbsp;the perception that investors and the market overall have on the company, and how “reestructuring” shows promise of improvement in the company’s situation. <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>Data and code are available at the github repository: <a href="https://github.com/rafabelokurows/layoffs_stock_price" class="uri">https://github.com/rafabelokurows/layoffs_stock_price</a></p>
<section id="obtaining-the-data-and-first-causal-estimation" class="level2"><h2 class="anchored" data-anchor-id="obtaining-the-data-and-first-causal-estimation">Obtaining the data and first Causal estimation</h2>
<p>First, I obtained daily trading data for SAP stocks on the New York Stock Exchange, symbol named <a href="https://finance.yahoo.com/quote/SAP/"><strong>SAP SE</strong></a>. Here, I used <a href="https://business-science.github.io/tidyquant/">tidyquant</a>, a great package for R programming language that has several reliable functions to streamline download and analysis of Financial data.</p>
<p><a href="https://github.com/rafabelokurows/layoffs_stock_price/blob/main/data/sap_stock_20240525.csv">Here’s the corresponding dataset</a>, with data as of May 23rd 2024.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sap_stock</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SAP"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tq_get</span><span class="op">(</span>get <span class="op">=</span> <span class="st">"stock.prices"</span>, from <span class="op">=</span> <span class="st">"2022-01-01"</span>, to <span class="op">=</span> <span class="st">"2024-05-23"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>While there are some possible spots where we could analyze ups or downs, we are concerned with the particular movement on Jan 23rd and after, as highlighted in the plot below.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sap_stock</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">adjusted</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"SAP Stock price"</span>, y <span class="op">=</span> <span class="st">"Closing (adjusted) Price"</span>, x <span class="op">=</span> <span class="st">""</span>,subtitle <span class="op">=</span> <span class="st">"Possible effect of layoffs on price"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">theme_tq</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2024-01-23"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                linetype<span class="op">=</span><span class="fl">4</span>, colour<span class="op">=</span><span class="st">"black"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Next, I’ve applied a Causal Effect estimation method to <strong>measure and quantify the Causal Effect of this intervention</strong>, i.e.&nbsp;the layoff, or to be more precise the day where the decision to layoff became public - 23rd Jan 24, <strong>on the response variable</strong>, the SAP stock prices after the date of intervention.</p>
<p>For that, I’ve used <code>CausalImpact</code>, package developed by the good folks at Google, for causal inference using Bayesian structural time-series models.</p>
<p>Given a response time series stock prices and a set of control time series, the package constructs a Bayesian structural time-series model. This model is then used to try and predict the <strong>counterfactual</strong>, i.e., how the response metric would have evolved after the intervention if the intervention had never occurred.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sap_stock_data</span> <span class="op">=</span> <span class="va">sap_stock</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">date</span>,<span class="va">adjusted</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>y<span class="op">=</span><span class="va">adjusted</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">sap_stock_data</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">gt</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<div id="zaipuddpkx" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#zaipuddpkx table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#zaipuddpkx thead, #zaipuddpkx tbody, #zaipuddpkx tfoot, #zaipuddpkx tr, #zaipuddpkx td, #zaipuddpkx th {
  border-style: none;
}

#zaipuddpkx p {
  margin: 0;
  padding: 0;
}

#zaipuddpkx .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zaipuddpkx .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#zaipuddpkx .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zaipuddpkx .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zaipuddpkx .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zaipuddpkx .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zaipuddpkx .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zaipuddpkx .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zaipuddpkx .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zaipuddpkx .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zaipuddpkx .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zaipuddpkx .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zaipuddpkx .gt_spanner_row {
  border-bottom-style: hidden;
}

#zaipuddpkx .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#zaipuddpkx .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zaipuddpkx .gt_from_md > :first-child {
  margin-top: 0;
}

#zaipuddpkx .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zaipuddpkx .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zaipuddpkx .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#zaipuddpkx .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#zaipuddpkx .gt_row_group_first td {
  border-top-width: 2px;
}

#zaipuddpkx .gt_row_group_first th {
  border-top-width: 2px;
}

#zaipuddpkx .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zaipuddpkx .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#zaipuddpkx .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#zaipuddpkx .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zaipuddpkx .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zaipuddpkx .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zaipuddpkx .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#zaipuddpkx .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zaipuddpkx .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zaipuddpkx .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zaipuddpkx .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zaipuddpkx .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zaipuddpkx .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zaipuddpkx .gt_left {
  text-align: left;
}

#zaipuddpkx .gt_center {
  text-align: center;
}

#zaipuddpkx .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zaipuddpkx .gt_font_normal {
  font-weight: normal;
}

#zaipuddpkx .gt_font_bold {
  font-weight: bold;
}

#zaipuddpkx .gt_font_italic {
  font-style: italic;
}

#zaipuddpkx .gt_super {
  font-size: 65%;
}

#zaipuddpkx .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#zaipuddpkx .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#zaipuddpkx .gt_indent_1 {
  text-indent: 5px;
}

#zaipuddpkx .gt_indent_2 {
  text-indent: 10px;
}

#zaipuddpkx .gt_indent_3 {
  text-indent: 15px;
}

#zaipuddpkx .gt_indent_4 {
  text-indent: 20px;
}

#zaipuddpkx .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="header gt_col_headings">
<th id="date" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">date</th>
<th id="y" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">y</th>
</tr></thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="date">2024-05-15</td>
<td class="gt_row gt_right" headers="y">190.055</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="date">2024-05-16</td>
<td class="gt_row gt_right" headers="y">190.670</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="date">2024-05-17</td>
<td class="gt_row gt_right" headers="y">192.800</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="date">2024-05-20</td>
<td class="gt_row gt_right" headers="y">195.300</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="date">2024-05-21</td>
<td class="gt_row gt_right" headers="y">194.720</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="date">2024-05-22</td>
<td class="gt_row gt_right" headers="y">193.910</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pre.period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">(</span><span class="st">"2022-01-03"</span><span class="op">)</span> ,<span class="op">(</span><span class="st">"2024-01-23"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">post.period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">(</span><span class="st">"2024-01-24"</span><span class="op">)</span>,<span class="op">(</span><span class="st">"2024-05-17"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>After transforming the data and setting the dates for the pre-intervention and post-intervention period, we run <code>CausalImpact</code>’s method for estimation.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">impact</span> <span class="op">&lt;-</span> <span class="fu">CausalImpact</span><span class="op">(</span><span class="va">sap_stock_data</span>, <span class="va">pre.period</span>, <span class="va">post.period</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">impact</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"original"</span>, <span class="st">"pointwise"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Causal Effect of layoffs on SAP stock price - first try"</span>,y<span class="op">=</span><span class="st">"Stock Price (USD)"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2022-06-01"</span><span class="op">)</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2024-05-17"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_date</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_date.html">label_date</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">"%Y %b"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Bricolage Grotesque"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And we can already see some promising results, with only the own stock time series to feed into the Causal Impact estimation. Some things to unpack here:</p>
<ul>
<li><p>The first gray vertical line shows the date of intervention (layoffs).</p></li>
<li><p>The horizontal blue dashed line on top is the counterfactual, i.e.&nbsp;what the stock price would be IF the layoffs hadn’t happened, according to our estimation.</p></li>
<li><p>The squiggly blue dashed line below means the daily difference between the actual stock price in the real world x our counterfactual estimation, and the amount ranges from close to 0 to almost 40USD depending on the day.</p></li>
</ul>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">impact</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Posterior inference {CausalImpact}

                         Average       Cumulative    
Actual                   183           14841         
Prediction (s.d.)        161 (8.6)     13072 (695.3) 
95% CI                   [144, 178]    [11669, 14425]
                                                     
Absolute effect (s.d.)   22 (8.6)      1768 (695.3)  
95% CI                   [5.1, 39]     [416.1, 3172] 
                                                     
Relative effect (s.d.)   14% (6.1%)    14% (6.1%)    
95% CI                   [2.9%, 27%]   [2.9%, 27%]   

Posterior tail-area probability p:   0.00642
Posterior prob. of a causal effect:  99.3576%

For more details, type: summary(impact, "report")</code></pre>
</div>
</div>
<p>You can also easily get the coefficients and Average Treatment Effect (or in this case, Average effect of the layoffs) of this estimation, and while the posterior probability of a causal effect looks great (+99%), I’m not loving the wide confidence interval for the effect (~3% to 27%), I think we could do better than that with some more data.</p>
</section><section id="improving-the-estimation" class="level2"><h2 class="anchored" data-anchor-id="improving-the-estimation">Improving the estimation</h2>
<p>Looking to improve the results, one option is to add covariates to the causal estimation. Good covariates should mainly:</p>
<ol type="1">
<li>Be highly correlated with the response time series</li>
<li>Not have been affected by the intervention</li>
</ol>
<p>Direct competitor stocks wouldn’t work here, because they <strong>could</strong> probably be positively affected when SAP’s stock price goes down or go down when SAP value is on the rise.</p>
<p>With that in mind, I’ve obtained stock prices for several other of <a href="https://stockanalysis.com/stocks/industry/software-application/">companies in the software sector</a> to find out which could make for good covariates to help improve the confidence in our results. And here they didn’t have to be software or IT companies, I just felt like it was easier going for some companies in the same sector. Don’t worry, we’ll exclude direct competitors if they come up as the top correlated stocks after these.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">url</span> <span class="op">=</span> <span class="st">"https://stockanalysis.com/stocks/industry/software-application/"</span></span>
<span><span class="va">page</span> <span class="op">=</span> <span class="fu">read_html</span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span><span class="va">software_stocks</span> <span class="op">=</span> <span class="va">page</span> <span class="op">%&gt;%</span> <span class="fu">html_elements</span><span class="op">(</span><span class="st">".symbol-table"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">html_table</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>   <span class="va">.</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">software_stocks</span> <span class="op">%&gt;%</span> <span class="va">head</span> <span class="op">%&gt;%</span> <span class="fu">gt</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<div id="iigacozzfo" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#iigacozzfo table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#iigacozzfo thead, #iigacozzfo tbody, #iigacozzfo tfoot, #iigacozzfo tr, #iigacozzfo td, #iigacozzfo th {
  border-style: none;
}

#iigacozzfo p {
  margin: 0;
  padding: 0;
}

#iigacozzfo .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#iigacozzfo .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#iigacozzfo .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#iigacozzfo .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#iigacozzfo .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#iigacozzfo .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#iigacozzfo .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#iigacozzfo .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#iigacozzfo .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#iigacozzfo .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#iigacozzfo .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#iigacozzfo .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#iigacozzfo .gt_spanner_row {
  border-bottom-style: hidden;
}

#iigacozzfo .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#iigacozzfo .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#iigacozzfo .gt_from_md > :first-child {
  margin-top: 0;
}

#iigacozzfo .gt_from_md > :last-child {
  margin-bottom: 0;
}

#iigacozzfo .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#iigacozzfo .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#iigacozzfo .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#iigacozzfo .gt_row_group_first td {
  border-top-width: 2px;
}

#iigacozzfo .gt_row_group_first th {
  border-top-width: 2px;
}

#iigacozzfo .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#iigacozzfo .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#iigacozzfo .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#iigacozzfo .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#iigacozzfo .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#iigacozzfo .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#iigacozzfo .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#iigacozzfo .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#iigacozzfo .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#iigacozzfo .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#iigacozzfo .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#iigacozzfo .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#iigacozzfo .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#iigacozzfo .gt_left {
  text-align: left;
}

#iigacozzfo .gt_center {
  text-align: center;
}

#iigacozzfo .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#iigacozzfo .gt_font_normal {
  font-weight: normal;
}

#iigacozzfo .gt_font_bold {
  font-weight: bold;
}

#iigacozzfo .gt_font_italic {
  font-style: italic;
}

#iigacozzfo .gt_super {
  font-size: 65%;
}

#iigacozzfo .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#iigacozzfo .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#iigacozzfo .gt_indent_1 {
  text-indent: 5px;
}

#iigacozzfo .gt_indent_2 {
  text-indent: 10px;
}

#iigacozzfo .gt_indent_3 {
  text-indent: 15px;
}

#iigacozzfo .gt_indent_4 {
  text-indent: 20px;
}

#iigacozzfo .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="header gt_col_headings">
<th id="No." class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">No.</th>
<th id="Symbol" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Symbol</th>
<th id="Company Name" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Company Name</th>
<th id="Market Cap" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Market Cap</th>
<th id="% Change" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">% Change</th>
<th id="Volume" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Volume</th>
<th id="Revenue" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Revenue</th>
</tr></thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="No.">1</td>
<td class="gt_row gt_left" headers="Symbol">CRM</td>
<td class="gt_row gt_left" headers="Company Name">Salesforce, Inc.</td>
<td class="gt_row gt_left" headers="Market Cap">264.46B</td>
<td class="gt_row gt_right" headers="% Change">-2.25%</td>
<td class="gt_row gt_right" headers="Volume">8,059,238</td>
<td class="gt_row gt_left" headers="Revenue">34.86B</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="No.">2</td>
<td class="gt_row gt_left" headers="Symbol">SAP</td>
<td class="gt_row gt_left" headers="Company Name">SAP SE</td>
<td class="gt_row gt_left" headers="Market Cap">228.05B</td>
<td class="gt_row gt_right" headers="% Change">0.18%</td>
<td class="gt_row gt_right" headers="Volume">648,669</td>
<td class="gt_row gt_left" headers="Revenue">34.52B</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="No.">3</td>
<td class="gt_row gt_left" headers="Symbol">INTU</td>
<td class="gt_row gt_left" headers="Company Name">Intuit Inc.</td>
<td class="gt_row gt_left" headers="Market Cap">169.94B</td>
<td class="gt_row gt_right" headers="% Change">-8.35%</td>
<td class="gt_row gt_right" headers="Volume">4,187,180</td>
<td class="gt_row gt_left" headers="Revenue">15.81B</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="No.">4</td>
<td class="gt_row gt_left" headers="Symbol">NOW</td>
<td class="gt_row gt_left" headers="Company Name">ServiceNow, Inc.</td>
<td class="gt_row gt_left" headers="Market Cap">151.39B</td>
<td class="gt_row gt_right" headers="% Change">-2.59%</td>
<td class="gt_row gt_right" headers="Volume">1,341,199</td>
<td class="gt_row gt_left" headers="Revenue">9.48B</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="No.">5</td>
<td class="gt_row gt_left" headers="Symbol">UBER</td>
<td class="gt_row gt_left" headers="Company Name">Uber Technologies, Inc.</td>
<td class="gt_row gt_left" headers="Market Cap">134.27B</td>
<td class="gt_row gt_right" headers="% Change">1.04%</td>
<td class="gt_row gt_right" headers="Volume">10,337,236</td>
<td class="gt_row gt_left" headers="Revenue">38.59B</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="No.">6</td>
<td class="gt_row gt_left" headers="Symbol">CDNS</td>
<td class="gt_row gt_left" headers="Company Name">Cadence Design Systems, Inc.</td>
<td class="gt_row gt_left" headers="Market Cap">80.08B</td>
<td class="gt_row gt_right" headers="% Change">-0.14%</td>
<td class="gt_row gt_right" headers="Volume">939,947</td>
<td class="gt_row gt_left" headers="Revenue">4.08B</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<p>NOTE_1: As they are ordered by Market Cap (Value), we see Salesforce and SAP at the top, but there are more than 100 companies in the list, so we’re gonna stick with the first 100 for brevity :)</p>
<p>NOTE_2: <a href="https://github.com/rafabelokurows/layoffs_stock_price/blob/main/data/list_software_stocks_20240525.csv">Here is the list</a> of software-related stocks we’ve obtained as of May 25th, 2024, just in case.</p>
<p>Now, we use tidyquant again to obtain data for all 100 stocks. You can access this particular dataset <a href="https://github.com/rafabelokurows/layoffs_stock_price/blob/main/data/all_stocks_20240525.csv">here</a>.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">stocks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">software_stocks</span><span class="op">$</span><span class="va">Symbol</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tq_get</span><span class="op">(</span>get <span class="op">=</span> <span class="st">"stock.prices"</span>, from <span class="op">=</span> <span class="st">"2022-01-03"</span>, to <span class="op">=</span> <span class="st">"2024-05-23"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_stock_data</span> <span class="op">=</span> <span class="va">stocks</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">symbol</span>, <span class="va">date</span>,<span class="va">adjusted</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">adjusted</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And then, we run a matching method available in package MarketMatching (which you can install with <code>devtools::install_github("https://github.com/klarsen1/MarketMatching")</code></p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu">MarketMatching</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MarketMatching/man/best_matches.html">best_matches</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">all_stock_data</span>,</span>
<span>                                   id<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span>                                   markets_to_be_matched <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SAP"</span><span class="op">)</span>,</span>
<span>                                   date_variable<span class="op">=</span><span class="st">"date"</span>,</span>
<span>                                   matching_variable<span class="op">=</span><span class="st">"adjusted"</span>,</span>
<span>                                   parallel<span class="op">=</span><span class="cn">F</span>,</span>
<span>                                   start_match_period<span class="op">=</span><span class="st">"2022-01-03"</span>,</span>
<span>                                   end_match_period<span class="op">=</span><span class="st">"2024-01-23"</span>,</span>
<span>                                   matches <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mm</span><span class="op">$</span><span class="va">BestMatches</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">symbol</span> <span class="op">==</span> <span class="st">"SAP"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">BestControl</span>,<span class="va">rank</span>,<span class="va">RelativeDistance</span>,<span class="va">Correlation</span>,<span class="va">Correlation_of_logs</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">software_stocks</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">Symbol</span> ,<span class="va">`Company Name`</span>,<span class="va">`Market Cap`</span>,<span class="va">Revenue</span><span class="op">)</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BestControl"</span><span class="op">=</span><span class="st">"Symbol"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">relocate</span><span class="op">(</span><span class="va">`Company Name`</span>,.before<span class="op">=</span><span class="va">rank</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">rename</span><span class="op">(</span>Symbol <span class="op">=</span> <span class="va">BestControl</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">RelativeDistance</span>,<span class="va">Correlation</span>,<span class="va">Correlation_of_logs</span><span class="op">)</span>,<span class="va">round</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">gt</span><span class="op">(</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>    <span class="fu">gt_highlight_rows</span><span class="op">(</span></span>
<span>        rows <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>        fill <span class="op">=</span> <span class="st">"#ccd5ae"</span>,</span>
<span>        bold_target_only <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<div id="efjjppxysu" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#efjjppxysu table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#efjjppxysu thead, #efjjppxysu tbody, #efjjppxysu tfoot, #efjjppxysu tr, #efjjppxysu td, #efjjppxysu th {
  border-style: none;
}

#efjjppxysu p {
  margin: 0;
  padding: 0;
}

#efjjppxysu .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#efjjppxysu .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#efjjppxysu .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#efjjppxysu .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#efjjppxysu .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#efjjppxysu .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#efjjppxysu .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#efjjppxysu .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#efjjppxysu .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#efjjppxysu .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#efjjppxysu .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#efjjppxysu .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#efjjppxysu .gt_spanner_row {
  border-bottom-style: hidden;
}

#efjjppxysu .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#efjjppxysu .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#efjjppxysu .gt_from_md > :first-child {
  margin-top: 0;
}

#efjjppxysu .gt_from_md > :last-child {
  margin-bottom: 0;
}

#efjjppxysu .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#efjjppxysu .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#efjjppxysu .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#efjjppxysu .gt_row_group_first td {
  border-top-width: 2px;
}

#efjjppxysu .gt_row_group_first th {
  border-top-width: 2px;
}

#efjjppxysu .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#efjjppxysu .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#efjjppxysu .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#efjjppxysu .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#efjjppxysu .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#efjjppxysu .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#efjjppxysu .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#efjjppxysu .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#efjjppxysu .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#efjjppxysu .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#efjjppxysu .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#efjjppxysu .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#efjjppxysu .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#efjjppxysu .gt_left {
  text-align: left;
}

#efjjppxysu .gt_center {
  text-align: center;
}

#efjjppxysu .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#efjjppxysu .gt_font_normal {
  font-weight: normal;
}

#efjjppxysu .gt_font_bold {
  font-weight: bold;
}

#efjjppxysu .gt_font_italic {
  font-style: italic;
}

#efjjppxysu .gt_super {
  font-size: 65%;
}

#efjjppxysu .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#efjjppxysu .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#efjjppxysu .gt_indent_1 {
  text-indent: 5px;
}

#efjjppxysu .gt_indent_2 {
  text-indent: 10px;
}

#efjjppxysu .gt_indent_3 {
  text-indent: 15px;
}

#efjjppxysu .gt_indent_4 {
  text-indent: 20px;
}

#efjjppxysu .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="header gt_col_headings">
<th id="Symbol" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Symbol</th>
<th id="Company Name" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Company Name</th>
<th id="rank" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">rank</th>
<th id="RelativeDistance" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">RelativeDistance</th>
<th id="Correlation" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Correlation</th>
<th id="Correlation_of_logs" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Correlation_of_logs</th>
<th id="Market Cap" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Market Cap</th>
<th id="Revenue" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Revenue</th>
</tr></thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Symbol" style="background-color: rgba(204,213,174,0.8)">PTC</td>
<td class="gt_row gt_left" headers="Company Name" style="background-color: rgba(204,213,174,0.8)">PTC Inc.</td>
<td class="gt_row gt_right" headers="rank" style="background-color: rgba(204,213,174,0.8)">1</td>
<td class="gt_row gt_right" headers="RelativeDistance" style="background-color: rgba(204,213,174,0.8)">0.214</td>
<td class="gt_row gt_right" headers="Correlation" style="background-color: rgba(204,213,174,0.8)">0.861</td>
<td class="gt_row gt_right" headers="Correlation_of_logs" style="background-color: rgba(204,213,174,0.8)">0.837</td>
<td class="gt_row gt_left" headers="Market Cap" style="background-color: rgba(204,213,174,0.8)">21.91B</td>
<td class="gt_row gt_left" headers="Revenue" style="background-color: rgba(204,213,174,0.8)">2.24B</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Symbol" style="background-color: rgba(204,213,174,0.8)">APPF</td>
<td class="gt_row gt_left" headers="Company Name" style="background-color: rgba(204,213,174,0.8)">AppFolio, Inc.</td>
<td class="gt_row gt_right" headers="rank" style="background-color: rgba(204,213,174,0.8)">2</td>
<td class="gt_row gt_right" headers="RelativeDistance" style="background-color: rgba(204,213,174,0.8)">0.325</td>
<td class="gt_row gt_right" headers="Correlation" style="background-color: rgba(204,213,174,0.8)">0.867</td>
<td class="gt_row gt_right" headers="Correlation_of_logs" style="background-color: rgba(204,213,174,0.8)">0.871</td>
<td class="gt_row gt_left" headers="Market Cap" style="background-color: rgba(204,213,174,0.8)">8.54B</td>
<td class="gt_row gt_left" headers="Revenue" style="background-color: rgba(204,213,174,0.8)">671.78M</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Symbol" style="background-color: rgba(204,213,174,0.8)">DUOL</td>
<td class="gt_row gt_left" headers="Company Name" style="background-color: rgba(204,213,174,0.8)">Duolingo, Inc.</td>
<td class="gt_row gt_right" headers="rank" style="background-color: rgba(204,213,174,0.8)">3</td>
<td class="gt_row gt_right" headers="RelativeDistance" style="background-color: rgba(204,213,174,0.8)">0.352</td>
<td class="gt_row gt_right" headers="Correlation" style="background-color: rgba(204,213,174,0.8)">0.830</td>
<td class="gt_row gt_right" headers="Correlation_of_logs" style="background-color: rgba(204,213,174,0.8)">0.784</td>
<td class="gt_row gt_left" headers="Market Cap" style="background-color: rgba(204,213,174,0.8)">7.68B</td>
<td class="gt_row gt_left" headers="Revenue" style="background-color: rgba(204,213,174,0.8)">583.00M</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Symbol">WK</td>
<td class="gt_row gt_left" headers="Company Name">Workiva Inc.</td>
<td class="gt_row gt_right" headers="rank">4</td>
<td class="gt_row gt_right" headers="RelativeDistance">0.421</td>
<td class="gt_row gt_right" headers="Correlation">0.658</td>
<td class="gt_row gt_right" headers="Correlation_of_logs">0.718</td>
<td class="gt_row gt_left" headers="Market Cap">4.36B</td>
<td class="gt_row gt_left" headers="Revenue">655.52M</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Symbol">MNDY</td>
<td class="gt_row gt_left" headers="Company Name">monday.com Ltd.</td>
<td class="gt_row gt_right" headers="rank">5</td>
<td class="gt_row gt_right" headers="RelativeDistance">0.484</td>
<td class="gt_row gt_right" headers="Correlation">0.680</td>
<td class="gt_row gt_right" headers="Correlation_of_logs">0.704</td>
<td class="gt_row gt_left" headers="Market Cap">11.91B</td>
<td class="gt_row gt_left" headers="Revenue">784.35M</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<p>Function <code>best_matches</code>, amongst other things, identifies the “markets”, in this case stocks prices, that show the highest similarity with the stock price for SAP. Those are the stocks that would make for the best control groups to use as predictors in the Causal Impact analysis.</p>
<p>After preparing the new dataset including stock prices for SAP and the two most similar stocks (PTC, DUOL and APPF), we run the CausalImpact method again. Another change which also help to improve the results was increasing the number of iterations of the model from the default 1000 to 5000 (beware, the model will take a bit longer to fit).</p>
<div class="cell preview-image">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sap_and_covariates</span> <span class="op">=</span> <span class="va">all_stock_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">symbol</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SAP"</span>,<span class="st">"PTC"</span>,<span class="st">"DUOL"</span>,<span class="st">"APPF"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">date</span>,<span class="va">symbol</span>,<span class="va">adjusted</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>values_from<span class="op">=</span><span class="va">adjusted</span>,names_from<span class="op">=</span><span class="va">symbol</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>y<span class="op">=</span><span class="va">SAP</span>,x1<span class="op">=</span><span class="va">PTC</span>,x2<span class="op">=</span><span class="va">DUOL</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">date</span>,<span class="va">y</span>,<span class="va">x1</span>,<span class="va">x2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">impact_2</span> <span class="op">&lt;-</span> <span class="fu">CausalImpact</span><span class="op">(</span><span class="va">sap_and_covariates</span>, <span class="va">pre.period</span>, <span class="va">post.period</span>,</span>
<span>                         model.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>niter <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">impact_2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"original"</span>, <span class="st">"pointwise"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Causal Effect layoffs on SAP stock price"</span>,y<span class="op">=</span><span class="st">"Stock Price (USD)"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2022-01-01"</span><span class="op">)</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2024-05-17"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_date</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_date.html">label_date</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">"%Y %b"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Bricolage Grotesque"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">impact_2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Posterior inference {CausalImpact}

                         Average       Cumulative    
Actual                   183           14841         
Prediction (s.d.)        162 (5.4)     13141 (437.3) 
95% CI                   [152, 173]    [12278, 13979]
                                                     
Absolute effect (s.d.)   21 (5.4)      1700 (437.3)  
95% CI                   [11, 32]      [862, 2562]   
                                                     
Relative effect (s.d.)   13% (3.8%)    13% (3.8%)    
95% CI                   [6.2%, 21%]   [6.2%, 21%]   

Posterior tail-area probability p:   2e-04
Posterior prob. of a causal effect:  99.97985%

For more details, type: summary(impact, "report")</code></pre>
</div>
</div>
<p>We get different (higher) estimated effects compared with the previous execution, and a narrower confidence interval: there is 95% confidence that the causal effect lies between 6,1% and 21%, instead of the 3,3% to 27% interval obtained in the first try. That can definitely be further improved, but it’s a good jump in quality from the first model.</p>
<p>For sake of brevity we’ll stop here, but also know you can fit your own Bayesian model, or passing additional arguments, include multiple seasonality terms and adjust other parameters of your Bayesian underlying model. Check the <a href="https://google.github.io/CausalImpact/CausalImpact.html">official vignette of CausalImpact</a> to see the additional model parameters you can pass to CausalImpact or if you’re a Bayesian aficionado, how to fit your own BSTS model.</p>
</section><section id="key-takeaways" class="level2"><h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<ul>
<li><p>Thanks to Google’s <code>CausalImpact</code> R package and some correlated stock as predictors, we calculate a posterior probability of causal effect of 99,89%. 😎</p></li>
<li><p>More data and more iterations of model fitting will give a much needed confidence boost.</p></li>
<li><p>Layoffs are good for business(?), at least the business that are already struggling or going through reestructuring.</p></li>
</ul>
<p>As always, hope you liked, and any feedback is appreciated.</p>
<p>Thanks for reading!</p>


</section><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>
<ol>
<li id="fn1"><p><a href="https://clutejournals.com/index.php/JABR/article/download/2195/2172/8714" class="uri">https://clutejournals.com/index.php/JABR/article/download/2195/2172/8714</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><a href="https://money.com/tech-layoffs-affect-stock-prices/" class="uri">https://money.com/tech-layoffs-affect-stock-prices/</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://utteranc.es/client.js" repo="rafabelokurows/rafabelokurows.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Made with <a href="https://quarto.org/">Quarto</a></p>
</div>   
    <div class="nav-footer-center">
<p><a href="mailto:rafabelokurows@gmail.com">Rafael Belokurows</a></p>
</div>
    <div class="nav-footer-right">
<p><a href="https://www.github.com/rafabelokurows/">Github</a></p>
</div>
  </div>
</footer>


</body></html>